<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Live Beat Detection</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <style>
    body {
            background-color: rgb(30, 30, 30)
        }
    </style>
  </head>

  <body>
    <div id = "tempo_container" class = "container-fluid text-light text-center">
        <h1 class = "center">Live Beat Detection</h1>
        <br>
        <canvas id = "beatCanvas" class="p-3 mb-2 bg-dark rounded"></canvas>
    </div>
  </body>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

<script type="text/javascript" src = "AudioContextMonkeyPatch.js"></script>
<!-- <script type="text/javascript" src = "scales.js"></script>  -->
<script type="text/javascript">

  var myAudio = document.querySelector('audio');

  const iOSSafari = isiOSSafari();

  function isiOSSafari() {
    const ua = window.navigator.userAgent;
    const iOS = !!ua.match(/iP(ad|hone)/i);
    const webkit = !!ua.match(/WebKit/i);
    return iOS && webkit && !ua.match(/CriOS/i);
  }

  if (navigator.mediaDevices) {
    console.log('getUserMedia supported.');
    navigator.mediaDevices.getUserMedia ({audio: true, video: false})
    .then(function(stream) {

        const sampleRate = 44100;
        const fftSize = 2048;
        const channels = 1;
        const threshold = 0.01;
        const minPeakGap = 0.25;
        var samplesSinceLastBeat = sampleRate * minPeakGap;
        const bufferLength = 1000 * fftSize;

        var audioCtx = new AudioContext();
        var source = audioCtx.createMediaStreamSource(stream);
        var analyser = audioCtx.createAnalyser();
        analyser.fftSize = fftSize;
        var filter = audioCtx.createBiquadFilter();
        filter.type = "highpass";
    
        source.connect(filter);
        filter.connect(analyser);

        var peaks = [];

        // canvas init
        var canvas = document.getElementById("beatCanvas");
        const dpr = window.devicePixelRatio || 1;
        const padding = 20;
        // canvas.width = canvas.offsetWidth * dpr;
        // canvas.height = (canvas.offsetHeight + padding * 2) * dpr;

        canvas.style.width ='100%';
        canvas.style.height='100%';
        // ...then set the internal size to match
        canvas.width  = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;

        var ctx = canvas.getContext("2d");
        ctx.scale(dpr, dpr);
        ctx.strokeStyle = "#fff";

        window.setInterval(tempo, 1000 * fftSize / sampleRate);
        
        function tempo() {
            var currSamples = new Float32Array(fftSize);
            analyser.getFloatTimeDomainData(currSamples);

            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            updatePeaks(currSamples, threshold);
            drawBeats(peaks);
        }
        
        function updatePeaks(samples, threshold) {

            for(var i = 0; i < peaks.length; i++) {
                peaks[i]-= fftSize;
            }

            //removes peaks no longer in the buffer
            var peak = peaks[0];
            while(peak < 0) {
                peaks.shift();
                peak = peaks[0];
            }

            if(samplesSinceLastBeat < sampleRate * minPeakGap) {
                samplesSinceLastBeat += fftSize;
            }
            else {
                for(var i = 0; i < samples.length; i++) {
                    if(Math.abs(samples[i]) > threshold) {
                        peaks.push(bufferLength - fftSize + i);
                        samplesSinceLastBeat = 0;
                        i = samples.length;
                    }
                }
            }
        }
        
        function drawBeats() {
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            for(var peak of peaks) {
                drawLine(peak / bufferLength * canvas.width);
            }
        }

        function drawLine(x) {
            ctx.beginPath();
            ctx.moveTo(x, 0);
            ctx.lineTo(x, canvas.offsetHeight - padding)
            ctx.stroke();
            ctx.closePath();
        }
    })
    .catch(function(err) {
        alert('The following getUserMedia error occured: ' + err);
        console.log('The following getUserMedia error occured: ' + err);
    });
  } else {
      alert('getUserMedia not supported on your browser!');
      console.log('getUserMedia not supported on your browser!');
    }
</script>
</html>
