<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">

    <title>Spectrogram Demo</title>

    <link rel="stylesheet" href="">
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>

  <body>
    <!--Div that will hold the chart-->
    <div id="chart_div"></div>
    <button onclick = "clearpeak()">Clear peak Frequencies</button>
    <br>
    <input id = 'smoothingconstantslider' type = 'range' min = '0' max = '100'>Smoothing Constant</input>
    <br>
    <label id = "peak">peak</label>
  </body>

<!--Load the AJAX API-->
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript" src="http://cwilso.github.com/AudioContext-MonkeyPatch/AudioContextMonkeyPatch.js">

  var myAudio = document.querySelector('audio');
  var smoothingconstantslider = document.getElementById("smoothingconstantslider");
  var graphData = [];
  var peak = [0, 0];

  // Load the Visualization API and the corechart package.
  google.charts.load('current', {'packages':['corechart', 'line']});
  var chart;
  var data;

  if (navigator.mediaDevices) {
    console.log('getUserMedia supported.');
    navigator.mediaDevices.getUserMedia ({audio: true, video: false})
    .then(function(stream) {
        // Create a MediaStreamAudioSourceNode
        // Feed the HTMLMediaElement into it
        
        var audioCtx = new AudioContext();
        var source = audioCtx.createMediaStreamSource(stream);
        var analyser = audioCtx.createAnalyser();
        analyser.fftSize = 256;
        source.connect(analyser);
      
        analyser.smoothingTimeConstant = smoothingconstantslider.value / 100;
        smoothingconstantslider.oninput = function() {
          analyser.smoothingTimeConstant = smoothingconstantslider.value / 100;
        }
        
        var frequencyArray = new Float32Array(analyser.frequencyBinCount); //BinCount will always be half the FFT size
        console.log(frequencyArray.length);
        graphData = new Array(frequencyArray.length);

        for(var i = 0; i < graphData.length; i++) {
          graphData[i] = [i * 22050 / frequencyArray.length, -100, -100]
          
        }

        function createSpectrogram() {

          analyser.getFloatFrequencyData(frequencyArray);

          peak = [0, -100];
          for(i = 0; i < graphData.length; i++) {
            if(frequencyArray[i] != -Infinity) {
              graphData[i][1] = frequencyArray[i];
              if(frequencyArray[i] > graphData[i][2]) {
                graphData[i][2] = frequencyArray[i];
              }

              if(graphData[i][1] > peak[1]) {
                peak = [graphData[i][0], graphData[i][1]];
              }
            }
          }
          data.removeRows(2, 128); //clears all frequency data
          drawChart();
        }

        
        // Set a callback to run when the Google Visualization API is loaded.
        google.charts.setOnLoadCallback(drawChart);

        //recalculates spectrogram and draws graph every quarter second
        window.setInterval(createSpectrogram, 250); 

        // Callback that creates and populates a data table,
        // instantiates the pie chart, passes in the data and
        // draws it.
        function drawChart() {
          chart = new google.visualization.LineChart(document.getElementById('chart_div'));
          data = new google.visualization.DataTable();
          // Create the data table.
          data.addColumn('number', 'Frequency');
          data.addColumn('number', 'Intensity');
          data.addColumn('number', 'peak Intensity')
          data.addRows(graphData);

          var options = {
            chart: {
              title:'Fourier Transform',
            },
            width:800,
            height:600,
            hAxis: {
              title: 'Frequency (Hz)',
              
            },
            vAxis: {
              title: 'Intensity (dB)',
              min: -100,
              viewWindow: {
                min: -100,
                peak: 50
              }
            },
            
          }
          chart.draw(data, options);
          document.getElementById("peak").innerHTML = peak[1] + " Decibels at " + peak[0] + " Hertz";
        }
      
    })
    .catch(function(err) {
        console.log('The following getUserMedia error occured: ' + err);
    });
  } else {
      console.log('getUserMedia not supported on your browser!');
    }

    function clearpeak() {
      for(var i = 0; i < graphData.length; i++) {
          graphData[i][2] = -100;
        }
    }
</script>
</html>
