<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">

    <title>Spectrogram Demo</title>

    <link rel="stylesheet" href="">
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>

  <body>
    <!--Div that will hold the chart-->
    <div id="chart_div"></div>
  </body>

<!--Load the AJAX API-->
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript">

  var myAudio = document.querySelector('audio');

  if (navigator.mediaDevices) {
      console.log('getUserMedia supported.');
      navigator.mediaDevices.getUserMedia ({audio: true, video: false})
      .then(function(stream) {

          // Load the Visualization API and the corechart package.
          google.charts.load('current', {'packages':['corechart']});
       
          // Create a MediaStreamAudioSourceNode
          // Feed the HTMLMediaElement into it
          var audioCtx = new AudioContext();
          var source = audioCtx.createMediaStreamSource(stream);
        
          var analyser = audioCtx.createAnalyser();
          analyser.smoothingTimeConstant = 0;
          source.connect(analyser);
        
          var frequencyArray = new Float32Array(analyser.frequencyBinCount);
          var graphData = new Array(frequencyArray.length);
          

          function createSpectrogram() {
  
            analyser.getFloatFrequencyData(frequencyArray);

            for(i = 0; i < frequencyArray.length; i++) {
              if(frequencyArray[i] == -Infinity) {
                graphData[i] = [i, -100];
              }
              else {
                graphData[i] = [i, frequencyArray[i]];
              }
            }
            // Set a callback to run when the Google Visualization API is loaded.
          google.charts.setOnLoadCallback(drawChart);
          console.log("replotting graph");
          }
          
          window.setInterval(createSpectrogram, 250); //recalculates spectrogram and draws graph every quarter second

          // Callback that creates and populates a data table,
          // instantiates the pie chart, passes in the data and
          // draws it.
          function drawChart() {

            // Create the data table.
            var data = new google.visualization.DataTable();
            data.addColumn('number', 'Frequency');
            data.addColumn('number', 'Intensity');
            data.addRows(graphData);

            // Set chart options
            var options = {'title':'Fourier Transform',
                          'width':400,
                          'height':300,
                          'vAxis.minValue': -100}
                        

            // Instantiate and draw our chart, passing in some options.
            var chart = new google.visualization.LineChart(document.getElementById('chart_div'));
            chart.draw(data, options);
          }
       
      })
      .catch(function(err) {
          console.log('The following getUserMedia error occured: ' + err);
      });
  } else {
      console.log('getUserMedia not supported on your browser!');
    }
</script>
</html>